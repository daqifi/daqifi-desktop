<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="DAQiFi"
           Manufacturer="DAQiFi"
           Version="3.0.1.0"
           UpgradeCode="ACA4F4E1-6DBB-47C0-A829-84AA1536C147"
           Language="1033">

    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="DAQiFiFolder" Name="DAQiFi">
        <Directory Id="INSTALLFOLDER" Name="DAQiFi Desktop"/>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ProgramMenuDAQiFi" Name="DAQiFi">
        <Directory Id="ProgramMenuDAQiFiDesktop" Name="DAQiFi"/>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of DAQiFi is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <Icon Id="Icon.exe" SourceFile="$(var.SourceDir)\$(var.MainExeName)"/>

    <!-- Force upgrade if already installed-->
    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    <Upgrade Id="ACA4F4E1-6DBB-47C0-A829-84AA1536C147">
      <UpgradeVersion Minimum="0.1.0.0"
                      Maximum="99.0.0.0"
                      Property="PREVIOUSVERSIONSINSTALLED"
                      IncludeMinimum="yes"
                      IncludeMaximum="no"
                      OnlyDetect="no"/>
    </Upgrade>

    <Feature Id="ProductFeature" Title="DAQiFiDesktop_Setup" Level="1" Display="expand">
      <ComponentRef Id="MainExecutable"/>
      <ComponentRef Id="UninstallProgramMenuItems"/>
      <ComponentGroupRef Id="HarvestedFiles" />
    </Feature>

    <!-- GUI Parameters -->
    <WixVariable Id="WixUIBannerBmp" Value="Images\WiFiDAQ_Banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="Images\WiFiDAQ_Dialog.bmp" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <UI>
      <ui:WixUI Id="WixUI_Minimal" />
      <UIRef Id="WixUI_ErrorProgressText" />

      <!-- Option to run after install -->
      <Property Id="WixUI_ExitDialogOptionalCheckboxText" Value="Launch DAQiFi" />
      <Property Id="WIXSHELLEXECTARGET" Secure="yes"/>
      <Property Id="LAUNCHAPPPLICATION" Secure="yes"/>

      <!-- Modify the existing ExitDialog -->
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication"
               Condition="WixUI_ExitDialogOptionalCheckbox AND NOT Installed" />
    </UI>

    <!-- Updated CustomAction to use ShellExecute -->
    <CustomAction Id="LaunchApplication"
                  Property="WIXSHELLEXECTARGET"
                  ExeCommand=""
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check" />

    <!-- Main Executable with Shortcuts - must be separate to define shortcuts -->
    <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="A0B50642-0EB2-48B2-B83E-5E2D62DA01E8">
      <File Id="DAQiFiEXE"
            Name="DAQiFi.exe"
            Source="$(var.SourceDir)\$(var.MainExeName)"
            KeyPath="yes">
        <Shortcut Id="DAQShortcutProgramMenu"
                  Directory="ProgramMenuDAQiFiDesktop"
                  Name="DAQiFi"
                  Show="normal"
                  WorkingDirectory="TARGETDIR"
                  Icon="Icon.exe"
                  Advertise="yes"/>
        <Shortcut Id="DAQiFiShortcut"
                  Directory="DesktopFolder"
                  Name ="DAQiFi"
                  WorkingDirectory ="TARGETDIR"
                  Icon="Icon.exe"
                  Advertise="yes"/>
      </File>
    </Component>

    <!-- Add the UninstallProgramMenuItems component -->
    <Component Id="UninstallProgramMenuItems" Directory="ProgramMenuDAQiFiDesktop" Guid="4E54BE2B-E403-48E5-AA1A-1CFC46ABA5C6">
      <RemoveFolder Id="RemoveProgramMenuDAQiFi" Directory="ProgramMenuDAQiFi" On="uninstall"/>
      <RemoveFolder Id="RemoveProgramMenuDAQiFiDesktop" Directory="ProgramMenuDAQiFiDesktop" On="uninstall"/>
      <RegistryValue Root="HKCU" Key="Software\DAQifi\DAQifi Desktop" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
    </Component>

    <!-- Auto-harvested files from publish directory -->
    <ComponentGroup Id="HarvestedFiles" Directory="INSTALLFOLDER">
      <Files Include="$(var.SourceDir)\**">
        <!-- Exclude the main exe since we handle it separately for shortcuts -->
        <Exclude Files="$(var.SourceDir)\$(var.MainExeName)" />
      </Files>
    </ComponentGroup>
  </Package>
</Wix>
