<Controls:Flyout x:Class="Daqifi.Desktop.View.Flyouts.DevicesFlyout"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:Controls="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
             xmlns:vm="clr-namespace:Daqifi.Desktop.ViewModels"
             xmlns:networkDataModel="clr-namespace:Daqifi.Desktop.DataModel.Network;assembly=Daqifi.Desktop.DataModel"
             xmlns:sys="clr-namespace:System;assembly=mscorlib" 
             xmlns:controls="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:local="clr-namespace:Daqifi.Desktop.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="500"
             Width="500" Height="600" 
             Position="Right" 
             Header="Device Settings"
             IsOpen="{Binding IsDeviceSettingsOpen, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
    
    <Controls:Flyout.Resources>
        <ObjectDataProvider MethodName="GetValues" ObjectType="{x:Type sys:Enum}" x:Key="WifiModes">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="networkDataModel:WifiMode" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider MethodName="GetValues" ObjectType="{x:Type sys:Enum}" x:Key="WifiSecurityTypes">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="networkDataModel:WifiSecurityType" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:NotNullToBoolConverter x:Key="NotNullToBoolConverter"/>
    </Controls:Flyout.Resources>

    <DockPanel LastChildFill="True">
        <!-- Device Info Banner - Always visible -->
        <Border DockPanel.Dock="Top" Background="#2D2D30" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Column="0" Grid.Row="0" 
                          Text="{Binding SelectedDevice.DevicePartNumber}"
                          FontSize="24" Foreground="White"/>
                <StackPanel Grid.Column="0" Grid.Row="1" 
                          Orientation="Horizontal" 
                          Margin="0,5,0,0">
                    <TextBlock Text="S/N: " Foreground="#CCCCCC"/>
                    <TextBlock Text="{Binding SelectedDevice.DeviceSerialNo}" 
                             Foreground="#CCCCCC"/>
                    <TextBlock Text=" | v" Foreground="#CCCCCC" Margin="10,0"/>
                    <TextBlock Text="{Binding SelectedDevice.DeviceVersion}" 
                             Foreground="#CCCCCC"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Style="{StaticResource MahApps.Styles.TabControl}">
            <!-- Data Acquisition Tab -->
            <TabItem Header="DATA ACQUISITION">
                <StackPanel Margin="15">
                    <GroupBox Header="Sampling Configuration">
                        <StackPanel>
                            <Label Content="Frequency (Hz)" FontWeight="SemiBold"/>
                            <TextBox Text="{Binding ElementName=FrequencySlider, Path=Value, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                     HorizontalAlignment="Center" 
                                     FontSize="24" 
                                     Width="100"
                                     Margin="0,0,0,10"/>
                            <Slider Name="FrequencySlider" 
                                   Minimum="1" Maximum="1000" 
                                   TickFrequency="1" 
                                   IsSnapToTickEnabled="True"
                                   Value="{Binding SelectedDevice.StreamingFrequency, Delay=500, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </TabItem>

            <!-- SD Card Tab -->
            <TabItem Header="SD CARD">
                <StackPanel Margin="15">
                    <Controls:ToggleSwitch 
                        Header="Logging State"
                        IsOn="{Binding IsSdCardLoggingEnabled, Mode=TwoWay}"
                        OnContent="Enabled" 
                        OffContent="Disabled"
                        ToolTip="Enable or disable logging to SD card. Note: This will disable WiFi streaming."
                        Margin="0,0,0,15"/>

                    <Label Content="Data Format" FontWeight="SemiBold"/>
                    <ComboBox 
                        Margin="0,0,0,15"
                        SelectedItem="{Binding SelectedDataFormat, Mode=TwoWay}">
                        <ComboBoxItem Content="Protobuf"/>
                        <ComboBoxItem Content="JSON"/>
                    </ComboBox>

                    <GroupBox Header="Stored Files">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <DockPanel Grid.Row="0" 
                                      LastChildFill="False" 
                                      Margin="0,0,0,10">
                                <Button 
                                    DockPanel.Dock="Left"
                                    Style="{StaticResource MahApps.Styles.Button.Square}"
                                    Content="Refresh List"
                                    Command="{Binding RefreshSdCardFilesCommand}"/>
                                <Button 
                                    DockPanel.Dock="Right"
                                    Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                                    Content="Download Selected"
                                    Command="{Binding DownloadSdCardFileCommand}"
                                    IsEnabled="{Binding SelectedSdCardFile, Converter={StaticResource NotNullToBoolConverter}}"/>
                            </DockPanel>

                            <ListView 
                                Grid.Row="1"
                                Height="250"
                                ItemsSource="{Binding SdCardFiles}"
                                SelectedItem="{Binding SelectedSdCardFile, Mode=TwoWay}">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="File Name" Width="250" DisplayMemberBinding="{Binding FileName}"/>
                                        <GridViewColumn Header="Size" Width="100" DisplayMemberBinding="{Binding FormattedSize}"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                    </GroupBox>
                </StackPanel>
            </TabItem>

            <!-- Network Tab -->
            <TabItem Header="NETWORK">
                <StackPanel Margin="15">
                    <Label Content="WiFi Mode" FontWeight="SemiBold"/>
                    <ComboBox Margin="0,0,0,15" 
                             ItemsSource="{Binding Source={StaticResource WifiModes}}" 
                             SelectedItem="{Binding SelectedDevice.NetworkConfiguration.Mode}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource EnumDescription}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <Label Content="Security Type" FontWeight="SemiBold"/>
                    <ComboBox Margin="0,0,0,15"
                             ItemsSource="{Binding Source={StaticResource WifiSecurityTypes}}" 
                             SelectedItem="{Binding SelectedDevice.NetworkConfiguration.SecurityType}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource EnumDescription}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <Label Content="Network SSID" FontWeight="SemiBold"/>
                    <TextBox Margin="0,0,0,15"
                             Text="{Binding SelectedDevice.NetworkConfiguration.Ssid, Mode=TwoWay}"/>

                    <Label Content="Password" FontWeight="SemiBold"/>
                    <TextBox Margin="0,0,0,15"
                             Text="{Binding SelectedDevice.NetworkConfiguration.Password, Mode=TwoWay}" />

                    <Button Content="Apply Network Settings" 
                            Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                            HorizontalAlignment="Right"
                            Command="{Binding UpdateNetworkConfigurationCommand}"/>
                </StackPanel>
            </TabItem>

            <!-- Firmware Tab -->
            <TabItem Header="FIRMWARE">
                <StackPanel Margin="15">
                    <TextBlock Text="Update Device Firmware" 
                             FontSize="16" 
                             FontWeight="SemiBold"
                             Margin="0,0,0,15"/>
                    
                    <DockPanel LastChildFill="True" Margin="0,0,0,10">
                        <Button DockPanel.Dock="Right" 
                                Content="Browse"
                                Style="{StaticResource MahApps.Styles.Button.Square}"
                                Margin="10,0,0,0"
                                Command="{Binding BrowseForFirmwareCommand}"/>
                        <TextBox Text="{Binding FirmwareFilePath, Mode=TwoWay}" />
                    </DockPanel>

                    <DockPanel LastChildFill="True">
                        <Button DockPanel.Dock="Right" 
                                Content="Update"
                                Style="{StaticResource MahApps.Styles.Button.Square.Accent}"
                                Margin="10,0,0,0"
                                Width="80"
                                Command="{Binding UploadFirmwareCommand}" />
                        <controls:MetroProgressBar Height="25" 
                                                 Minimum="0" 
                                                 Maximum="100" 
                                                 Value="{Binding UploadFirmwareProgress}" />
                    </DockPanel>
                </StackPanel>
            </TabItem>
        </TabControl>
    </DockPanel>
</Controls:Flyout>
